<!doctype html>
<html lang="en">
    <head>
        <!-- Template the <head> -->
        <title>Local Racer</title>
        <link href="css/bootstrap.css" rel="stylesheet">
        <style>
              html, body, #map-canvas {
                height: 100%;
                margin: 0px;
                padding: 0px
              }
        </style>
    </head>
    <body>
        <!-- Template the navbar -->
        <div class="navbar navbar-default navbar-static-top">
            <div class="container">
                <div class="navbar-header">
                  <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                  </button>
                </div>
                <div class="navbar-collapse collapse" style="max-width:812px;min-width:480px;margin-left:auto;margin-right:auto;">
                  <ul class="nav navbar-nav">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="#leaders">Leaderboards</a></li>
                    <li class="active"><a href="play.html">Play</a></li>
                  </ul>
                </div>
            </div>
        </div>

        <div id="header"><input id="map" style="display:none;" value="1"></input></div>

        <div id="sidebar"></div>

        <div class="container">
          <div class="row">
            <div class="col-lg-12" style="text-align:center;">
              <h2>Sign Up Today!</h2>
              <div class="test" style="padding-bottom:20px;">
                  <input type="text" id="email" placeholder="Email"></input>
                  <input type="text" id="vehicle" placeholder="Vehicle"></input>
                  <input type="text" id="time" style="display:none;"></input>
                  <a class="btn btn-success save">Save</a>
              </div>
            </div>
          </div>
          <div id="map-canvas" style="position:absolute;width:100%;height:900px;left:0;"></div>


        </div>

        <footer>
            <div class="container">
            </div>
        </footer>

        <script type="text/template" id="tpl-race-list-item">
        	<a href='#races/<%= id %>'><%= name %></a>
        </script>
        <script type="text/template" id="tpl-race-details">
            <div class="form-left-col">
                <label>Id:</label>
                <input type="text" id="raceId" name="id" value="<%= id %>" disabled />
                <label>Email:</label>
                <input type="text" id="email" name="email" value="<%= email %>" required/>
                <label>Vehicle:</label>
                <input type="text" id="vehicle" name="vehicle" value="<%= vehicle %>"/>
                <label>Map:</label>
                <input type="text" id="map" name="map" value="<%= map %>"/>
                <label>Time:</label>
                <input type="text" id="time" name="time"  value="<%= time %>"/>
            </div>
        </script>
        <!--<script src="js/jquery-1.9.1.min.js"></script>  //ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js -->
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
        <script src="js/bootstrap.min.js"></script>
        <script src="js/underscore.js"></script>
        <script src="js/backbone.js"></script>
        <script src="js/application.js"></script>
        <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=true&v=3&libraries=geometry"></script>
        <script>
        function initialize() {
          var mapOptions = {
            zoom: 6,
            mapTypeId: google.maps.MapTypeId.ROADMAP
          };

          map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

        var marker = null;
        var A = new google.maps.LatLng(40.485340, -74.436923);
        var B = new google.maps.LatLng(40.4844, -74.437877);

        // function callBack(startTime) {
        //     navigator.geolocation.getCurrentPosition(function(position) {
        //         var newPoint = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
        //         //CODE
        //             return;
        //         } else {
        //             callBack();
        //         }
        //     }
        // }

        function autoUpdate() {
          navigator.geolocation.getCurrentPosition(function(position) {
            var newPoint = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);

            if (marker) {
              // Marker already created - Move it
              marker.setPosition(newPoint);

            } else {
              // Marker does not exist - Create it
              marker = new google.maps.Marker({
                position: newPoint,
                map: map
              });
            }

            // Center the map on the new position
            map.setCenter(newPoint);
          });

          // Call the autoUpdate() function every 5 seconds
          setTimeout(autoUpdate, 5000);

          navigator.geolocation.getCurrentPosition(function(position) {
            var newPointOne = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);

              if (google.maps.geometry.spherical.computeDistanceBetween(newPointOne, A) < 15) {
                  var r = confirm("You are nearing a checkpoint. Would you like to start a race?");
                  if (r==true) {
                      startTime = Date.now();
                      console.warn(startTime);
                  }
              }

              if (google.maps.geometry.spherical.computeDistanceBetween(newPointOne, B) < 15) {
                  endTime = Date.now();
                  alert('You finished the race! Hit the save button');
                  console.log('end time' + endTime);
                  finalTime = (endTime - startTime) / 1000;
                  console.warn('final time' + finalTime);
                  $('#time').attr('value', finalTime);
              }
          });

        }

        autoUpdate();

        var directionsService = new google.maps.DirectionsService();
        var directionsRequest = {
          origin: A,
          destination: B,
          travelMode: google.maps.DirectionsTravelMode.DRIVING,
          unitSystem: google.maps.UnitSystem.METRIC
        };

        directionsService.route(
          directionsRequest,
          function(response, status)
          {
            if (status == google.maps.DirectionsStatus.OK)
            {
              new google.maps.DirectionsRenderer({
                map: map,
                directions: response
              });
            }
            else
              $("#error").append("Unable to retrieve your route<br />");
          }
          );
      }
      google.maps.event.addDomListener(window, 'load', initialize);
        </script>
    </body>
</html>