<!doctype html>
<html lang="en">
    <head>
        <!-- Template the <head> -->
        <title>Get There First</title>
        <link href="css/bootstrap.css" rel="stylesheet">
        <style>
              html, body, #map-canvas {
                height: 100%;
                margin: 0px;
                padding: 0px
              }
        </style>
    </head>
    <body>
        <!-- Template the navbar -->
        <div class="navbar navbar-default navbar-static-top">
            <div class="container">
                <div class="navbar-header">
                  <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                  </button>
                </div>
                <div class="navbar-collapse collapse" style="max-width:812px;min-width:480px;margin-left:auto;margin-right:auto;">
                  <ul class="nav navbar-nav">
                    <li class="active"><a href="index.html">Home</a></li>
                    <li><a href="leaderboard.html">Leaderboards</a></li>
                    <li><a href="play.html">Play</a></li>
                  </ul>
                </div>
            </div>
        </div>

        <div id="header"><input id="map" style="display:none;" value="1"></input></div>

        <div id="sidebar"></div>

        <div class="jumbotron" style="background-image:url('image/ferrari.jpg');background-color:rgb(85,81,72);background-repeat:no-repeat;background-size:cover;height:500px;background-position:center;">
          <div class="container" style="text-align:left;color:white;text-shadow:2px 2px 5px #333;">
            <h1>Want to be a bad ass and race your friends?</h1>
            <p>Use Get There First!</p>
          </div>
        </div>

        <div class="container">
          <div class="row">
            <div class="col-lg-12" style="text-align:center;height:450px;">
              <h2>Sign Up Today!</h2>
              <div class="test" style="padding-bottom:40px;">
                  <input type="text" id="email" placeholder="Email"></input>
                  <input type="text" id="vehicle" placeholder="Vehicle"></input>
                  <input type="text" id="time" value="19998" style="display:none;"></input>
                  <a class="btn btn-success save">Save</a>
              </div>
              <table class="table">
                  <thead>
                      <tr>
                          <th style="text-align:center;">Email</th>
                          <th style="text-align:center;">Vehicle</th>
                          <th style="text-align:center;">Map</th>
                          <th style="text-align:center;">Time</th>
                      </tr>
                  </thead>
                  <tbody id="leaderboard">
                  </tbody>
              </table>
              <div id="sidebar"></div>
              <div id="map-canvas"></div>
              <br>
            </div>
          </div>

        </div>

        <footer>
            <div class="container">
            </div>
        </footer>

        <script type="text/template" id="tpl-race-list-item">
        	<tr>
                <td><%= get('email') %></td>
                <td><%= get('vehicle') %></td>
                <td><%= get('map') %></td>
                <td><%= get('time') / 1000 %> Seconds</td>
            </tr>
        </script>
        <!--<script src="js/jquery-1.9.1.min.js"></script>  //ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js -->
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
        <script src="js/bootstrap.min.js"></script>
        <script src="js/underscore.js"></script>
        <script src="js/backbone.js"></script>
        <script src="js/application.js"></script>
        <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=true&v=3&libraries=geometry"></script>
        <script>
        function initialize() {
            console.warn($('#time').val());
          var mapOptions = {
            zoom: 6,
            mapTypeId: google.maps.MapTypeId.ROADMAP
          };

          map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

        var marker = null;
        var A = new google.maps.LatLng(40.485340, -74.436923);
        var B = new google.maps.LatLng(40.4844, -74.437877);

        // function callBack(startTime) {
        //     navigator.geolocation.getCurrentPosition(function(position) {
        //         var newPoint = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
        //         //CODE
        //             return;
        //         } else {
        //             callBack();
        //         }
        //     }
        // }

        function autoUpdate() {
          navigator.geolocation.getCurrentPosition(function(position) {
            var newPoint = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);

            if (marker) {
              // Marker already created - Move it
              marker.setPosition(newPoint);

            } else {
              // Marker does not exist - Create it
              marker = new google.maps.Marker({
                position: newPoint,
                map: map
              });
            }

            // Center the map on the new position
            map.setCenter(newPoint);
          });

          // Call the autoUpdate() function every 5 seconds
          setTimeout(autoUpdate, 5000);

          navigator.geolocation.getCurrentPosition(function(position) {
            var newPointOne = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);

              if (google.maps.geometry.spherical.computeDistanceBetween(newPointOne, A) < 15) {
                  var r = confirm("You are nearing a checkpoint. Would you like to start a race?");
                  if (r==true) {
                      startTime = Date.now();
                      console.warn(startTime);
                  }
              }

              if (google.maps.geometry.spherical.computeDistanceBetween(newPointOne, B) < 15) {
                  alert("You just finished the race! Click the save button!");
                  endTime = Date.now();
                  console.log('end time' + endTime);
                  finalTime = endTime - startTime;
                  console.warn('final time' + finalTime);
                  console.log($('#time').attr('value'));
                  $('#time').val(finalTime);
                  console.log($('#time').attr('value'));

              }
          });

        }

        autoUpdate();

        var directionsService = new google.maps.DirectionsService();
        var directionsRequest = {
          origin: A,
          destination: B,
          travelMode: google.maps.DirectionsTravelMode.DRIVING,
          unitSystem: google.maps.UnitSystem.METRIC
        };

        directionsService.route(
          directionsRequest,
          function(response, status)
          {
            if (status == google.maps.DirectionsStatus.OK)
            {
              new google.maps.DirectionsRenderer({
                map: map,
                directions: response
              });
            }
            else
              $("#error").append("Unable to retrieve your route<br />");
          }
          );
      }
      google.maps.event.addDomListener(window, 'load', initialize);
        </script>
    </body>
</html>